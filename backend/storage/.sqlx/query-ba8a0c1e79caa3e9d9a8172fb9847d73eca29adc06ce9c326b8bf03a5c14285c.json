{
  "db_name": "PostgreSQL",
  "query": "\n            WITH matching_series AS (\n                -- Find series that match the search query\n                SELECT id\n                FROM series\n                WHERE $2::TEXT IS NOT NULL AND name ILIKE '%' || $2 || '%'\n            ),\n            dynamic_limit AS (\n                -- Use a higher limit (50) if any series match, otherwise use the provided limit\n                SELECT CASE\n                    WHEN EXISTS (SELECT 1 FROM matching_series) AND $2 != '' THEN 50\n                    ELSE $4\n                END AS result_limit\n            ),\n            latest_torrent_per_title_group AS (\n                -- Find the latest torrent for each title group with uploader info\n                SELECT DISTINCT ON (eg.title_group_id)\n                    eg.title_group_id,\n                    t.created_at AS torrent_created_at,\n                    t.created_by_id,\n                    t.uploaded_as_anonymous,\n                    u.id AS user_id,\n                    u.username,\n                    u.warned,\n                    u.banned\n                FROM torrents t\n                JOIN edition_groups eg ON eg.id = t.edition_group_id\n                JOIN users u ON u.id = t.created_by_id\n                WHERE t.deleted_at IS NULL\n                ORDER BY eg.title_group_id, t.created_at DESC\n            )\n            SELECT jsonb_agg(data)\n                FROM (\n                    SELECT jsonb_build_object(\n                        'id', tg.id, 'content_type', tg.content_type, 'name', tg.name, 'platform', tg.platform, 'covers', tg.covers,\n                        'original_release_date', tg.original_release_date,\n                        'original_release_date_only_year_known', tg.original_release_date_only_year_known,\n                        'edition_groups', COALESCE(\n                            jsonb_agg(\n                                jsonb_build_object(\n                                    'id', eg.id,\n                                    'name', eg.name,\n                                    'release_date', eg.release_date,\n                                    'distributor', eg.distributor,\n                                    'source', eg.source,\n                                    'additional_information', eg.additional_information\n                                )\n                            ) FILTER (WHERE eg.id IS NOT NULL),\n                            '[]'::jsonb\n                        ),\n                        'series', CASE WHEN s.id IS NOT NULL THEN\n                            jsonb_build_object('id', s.id, 'name', s.name)\n                            ELSE NULL\n                        END,\n                        'latest_torrent_uploaded_by', CASE\n                            WHEN ltu.uploaded_as_anonymous THEN NULL\n                            WHEN ltu.user_id IS NOT NULL THEN\n                                jsonb_build_object('id', ltu.user_id, 'username', ltu.username, 'warned', ltu.warned, 'banned', ltu.banned)\n                            ELSE NULL\n                        END,\n                        'latest_torrent_uploaded_at', ltu.torrent_created_at\n                    ) as data\n                    FROM title_groups tg\n                    LEFT JOIN edition_groups eg ON eg.title_group_id = tg.id\n                    LEFT JOIN series s ON s.id = tg.series_id\n                    LEFT JOIN latest_torrent_per_title_group ltu ON ltu.title_group_id = tg.id\n                    LEFT JOIN (\n                        SELECT edition_group_id, MAX(created_at) as created_at\n                        FROM torrents\n                        GROUP BY edition_group_id\n                    ) AS latest_torrent ON latest_torrent.edition_group_id = eg.id\n                    WHERE ($1::INT IS NOT NULL AND tg.id = $1)\n                        OR (\n                            $2::TEXT IS NOT NULL\n                            AND (\n                                tg.name ILIKE '%' || $2 || '%'\n                                OR $2 = ANY(tg.name_aliases)\n                                OR (s.name IS NOT NULL AND s.name ILIKE '%' || $2 || '%')\n                            )\n                        )\n                        AND ($3::content_type_enum IS NULL OR tg.content_type = $3::content_type_enum)\n                    GROUP BY tg.id, s.id, s.name, ltu.uploaded_as_anonymous, ltu.user_id, ltu.username, ltu.warned, ltu.banned, ltu.torrent_created_at\n                    ORDER BY MAX(latest_torrent.created_at) DESC NULLS LAST\n                    LIMIT (SELECT result_limit FROM dynamic_limit)\n                ) AS subquery;\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "jsonb_agg",
        "type_info": "Jsonb"
      }
    ],
    "parameters": {
      "Left": [
        "Int4",
        "Text",
        {
          "Custom": {
            "name": "content_type_enum",
            "kind": {
              "Enum": [
                "movie",
                "video",
                "tv_show",
                "music",
                "podcast",
                "software",
                "book",
                "collection"
              ]
            }
          }
        },
        "Int4"
      ]
    },
    "nullable": [
      null
    ]
  },
  "hash": "ba8a0c1e79caa3e9d9a8172fb9847d73eca29adc06ce9c326b8bf03a5c14285c"
}
